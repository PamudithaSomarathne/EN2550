\documentclass[11pt, a4paper]{article}

\usepackage[english]{babel}
\usepackage{float}
\usepackage{graphicx}
\usepackage[margin=0.5in]{geometry}
\usepackage{hyperref}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{listings}
\usepackage{amsmath}

\title{{\Large \textbf{EN2550 Assignment 02}}}
\author{{\large 180616T P.M.P.H.Somarathne}}
\date{\tiny}

\begin{document}

\maketitle

\section{2D Transformations}
Rotation, translation, scaling, reflection, shear are the applied as basic transformations.\cite{T} Euclidian, similarity and affinity transformations are derived from these basic transformations. Perspective transformation is applied using a homography matrix.
\begin{figure}[H]
	\centering
	\includegraphics[width=.75\textwidth]{./images/2Dtransform.png}
	\caption{\textit{2D transformation results}}
	\label{fig:2Dt}
\end{figure}

\section{Warping Using a Given Homography}
Combined img1.ppm and img5.ppm by using the provided homography matrix(H1to5p).\cite{VGG}
\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q2im1.jpg}
		\caption{{\small \textit{img1.ppm}}}
		\label{fig:2im1}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q2im5.jpg}
		\caption{{\small \textit{img5.ppm}}}
		\label{fig:2im5}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q2im1Warp.jpg}
		\caption{{\small \textit{Warped and stitched image}}}
		\label{fig:2imw}
	\end{subfigure}
	\caption{Image warping using given homography}
\end{figure}

\section{Warping Using Mouse-Clicked Points and OpenCV}
Combined img1.ppm and img5.ppm with homography matrix generated by mouse-clicked points and \textbf{cv2.findHomography()} function. The stitching is not as accurate as the above one due to the inaccuracies in clicking the points by the user.

\begin{lstlisting}[numbers=left,frame=single,language=python,caption=Calculating homography using OpenCV and stitching]
H,_ = cv.findHomography(p2,p1)
im5_warped = cv.warpPerspective(im5, H, (1000,1000))
im5_warped[0:im1.shape[0], 0:im1.shape[1]] = im1
\end{lstlisting}

\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q3im1.jpg}
		\caption{{\small \textit{img1.ppm}}}
		\label{fig:3im1}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q3im5.jpg}
		\caption{{\small \textit{img5.ppm}}}
		\label{fig:3im5}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q3im1Warp.jpg}
		\caption{{\small \textit{Warped and stitched image}}}
		\label{fig:3imw}
	\end{subfigure}
	\caption{Image warping mouse clicked points}
\end{figure}

\section{Warping Using Mouse-Clicked Points without OpenCV}
Combined img1.ppm and img5.ppm with homography matrix generated by mouse-clicked points and a function\cite{MITHomo}. Here also stitching is not as accurate, due to the inaccuracies in clicking the points by the user.
\[The\ homography\ matrix(H)\ corresponds\ to\ the\ eigenvector\ of\ A\ with\ smallest\ eigenvalue,\ in\ AH=0\]
\[\begin{bmatrix}
x_{1} &y_{1} & 1& 0& 0& 0& -x_{1}^{'}x_{1} &-x_{1}^{'}y_{1} &-x_{1}^{'}\\
0& 0& 0& x_{1} &y_{1} & 1& -y_{1}^{'}x_{1} &-y_{1}^{'}y_{1} &-y_{1}^{'}\\
\\
x_{n} &y_{n} & 1& 0& 0& 0& -x_{n}^{'}x_{n} &-x_{n}^{'}y_{n} &-x_{n}^{'}\\
0& 0& 0& x_{n} &y_{n} & 1& -y_{n}^{'}x_{n} &-y_{n}^{'}y_{n} &-y_{n}^{'}\\
\end{bmatrix}
\begin{bmatrix}
h_{00}\\
h_{01}\\
h_{02}\\
h_{10}\\
h_{11}\\
h_{12}\\
h_{20}\\
h_{21}\\
h_{22}
\end{bmatrix}=\begin{bmatrix}
0\\
0\\
0\\
0\\
0\\
0\\
0\\
0\\
0
\end{bmatrix}
\]
\[where\ x_{i},y_{i}\ are\ the\ coordinates\ of\ source\ image\ and\ x_{i}^{'},y_{i}^{'}\ are\ the\ corresponding\ destination\ points.\]

\begin{lstlisting}[numbers=left,frame=single,language=python,caption=Calculating homography without OpenCV]
def findHomography(srcPnts, dstPnts):
    A = []
    for i in range(len(srcPnts)):
        A.append([srcPnts[i][0], srcPnts[i][1], 1, 0, 0, 0,\
        	-dstPnts[i][0]*srcPnts[i][0], -dstPnts[i][0]*srcPnts[i][1],\
        	-dstPnts[i][0]])
        A.append([0, 0, 0, srcPnts[i][0], srcPnts[i][1], 1,\
        	-dstPnts[i][1]*srcPnts[i][0], -dstPnts[i][1]*srcPnts[i][1],\
        	-dstPnts[i][1]])
    A = np.array(A)
    eigval, eigvect = np.linalg.eig(A.T@A)
    ind = eigval.argsort()[0]
    return eigvect.T[ind].reshape((3,3))
\end{lstlisting}

\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q3im1.jpg}
		\caption{{\small \textit{img1.ppm}}}
		\label{fig:3im1}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q3im5.jpg}
		\caption{{\small \textit{img5.ppm}}}
		\label{fig:3im5}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Q4im1Warp.jpg}
		\caption{{\small \textit{Warped and stitched image}}}
		\label{fig:3imw}
	\end{subfigure}
	\caption{Image warping mouse clicked points without OpenCV}
\end{figure}

\section{BONUS}
\subsection{Computing the Homography Using SuperGlue and RANSAC}
Used SuperGlue Pretrained Network\cite{SuperGlue} to generate the matching pairs. From the pairs, only using pairs with above 90\% confidence. Homography matrix is generated by \textbf{cv2.findHomography} with the method as \textbf{cv2.RANSAC}. RANSAC re-projection threshold is given as 5.0
\begin{lstlisting}[numbers=left,frame=single,language=python,caption=Using points from SuperGlue for homography generation]
# Accessing the results
npz = np.load('graffiti\output\img1_img5_matches.npz')
keypoints0,keypoints1 = npz['keypoints0'],npz['keypoints1']
pairs,confidence = npz['matches'],npz['match_confidence']
p1,p2 = [],[]
for i in range(keypoints0.shape[0]):
    if pairs[i]!=-1 and confidence[i]>0.75:
        p1.append(keypoints0[i])
        p2.append(keypoints1[pairs[i]])
p1,p2 = np.array(p1),np.array(p2)
# Using RANSAC to calculate the homography
H,_ = cv.findHomography(p2,p1,cv.RANSAC,5.0)
\end{lstlisting}
\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.65\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./SuperGluePretrainedNetwork-master/graffiti/output/img1_img5_matches.png}
		\caption{{\small \textit{SuperGlue Output}}}
		\label{fig:spout1}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Bonusim1Warp.jpg}
		\caption{{\small \textit{Image warped with SuperGlue and RANSAC}}}
		\label{fig:out5a}
	\end{subfigure}
	\caption{Image warping using SuperGlue and RANSAC}
\end{figure}

\subsection{Stitching multiple images}
Continuously applied mouse-clicked point extraction, homography calculation with OpenCV and stitching with OpenCV to stitch 3 images of the hill. After each stitching the black strips at the right edge and bottom edge have been removed to allow next stitching process. However, the seam handling approach could not be completed accurately.
\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/hill/1.jpg}
		\caption{{\small \textit{Hill 1}}}
		\label{fig:h1}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/hill/2.jpg}
		\caption{{\small \textit{Hill 2}}}
		\label{fig:h2}
	\end{subfigure}
	\hfill
		\begin{subfigure}[b]{0.3\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/hill/3.jpg}
		\caption{{\small \textit{Hill 3}}}
		\label{fig:h3}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.75\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/panorama.jpg}
		\caption{{\small \textit{Stitched panorama image}}}
		\label{fig:pano}
	\end{subfigure}
	\caption{Panorama stitching process}
\end{figure}

\subsection{Replacement for cv2.warpPerspective}
I have tried to code a function for stitching images similar to \textbf{cv2.warpPerspective}. However, I couldn't debug it completely. Below is the code and the resultant image from the current revision.

\begin{lstlisting}[numbers=left,frame=single,language=python,caption=warpPerspective test function]
def warpPerspective(image, homography):
    width,height,channels = image.shape
    a, b, c, d = (0,0,1), (0,height-1,1), (width-1,height-1,1), (width-1,0,1)
    corners = np.array([a, b, c, d]).T
    newCorners = np.matmul(homography,corners)
    newCorners = (newCorners/newCorners[2,:]).astype(int)
    maxSize = int(np.max(newCorners))
    warpedImage = np.zeros((maxSize,maxSize,channels),dtype=np.uint8)
    h_inv = np.linalg.inv(homography)
    for i in range(maxSize):
        for j in range(maxSize):
            oldCoord = np.matmul(h_inv, [i,j,1])
            oldCoord = (oldCoord/oldCoord[2]).astype(int)
            x,y = oldCoord[:2]
            if (0<=x<width) and (0<=y<height): warpedImage[i,j] = image[x,y]
    return warpedImage
\end{lstlisting}

\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Bim1.jpg}
		\caption{{\small \textit{img1.ppm}}}
		\label{fig:h1}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Bim4.jpg}
		\caption{{\small \textit{img4.ppm}}}
		\label{fig:h2}
	\end{subfigure}
	\hfill
		\begin{subfigure}[b]{0.32\textwidth}
		\centering
		\includegraphics[width=\textwidth]{./images/Bim1Warp.jpg}
		\caption{{\small \textit{Output of the function}}}
		\label{fig:h3}
	\end{subfigure}
	\hfill
	\caption{warpPerspective test function}
\end{figure}

Full code available at \url{https://github.com/PamudithaSomarathne/EN2550/tree/master/2\%20Alignment}

\begin{thebibliography}{AA}
\bibitem{T}
2D-Translation in Computer Graphics\\
\url{https://www.gatevidyalay.com/2d-transformation-in-computer-graphics-translation-examples/}

\bibitem{VGG}
Graffiti Image Set\\
\url{https://www.robots.ox.ac.uk/~vgg/data/affine/}

\bibitem{SuperGlue}
SuperGlue Inference and Evaluation Demo Script\\
\url{https://github.com/magicleap/SuperGluePretrainedNetwork}

\bibitem{MITHomo}
Lecture 13: Homographies and RANSAC, MIT CSAIL\\
\url{http://6.869.csail.mit.edu/fa12/lectures/lecture13ransac/lecture13ransac.pdf}

\nocite{T, VGG, SuperGlue, MITHomo}
\end{thebibliography}

\end{document}